<div class="scan-results">
  <h3 class="scan-results__title">Scan Results</h3>
  @if (driverCount(); as driverCount) {
  <span style="margin-bottom: 12px">Active Drivers: {{ driverCount }}</span>
  }

  <div class="scan-results__content">
    <!--  -->
    <!-- Violations conditional expansion panel -->
    @if (violations().length > 0) {
    <mat-accordion>
      <mat-expansion-panel style="margin-bottom: 8px">
        <mat-expansion-panel-header>
          <mat-panel-title
            >Violations
            <div
              style="margin-left: auto"
              matBadge="{{ violationsCount() ? violationsCount() : null }}"
              matBadgePosition="below after"
              matBadgeSize="medium"
            ></div
          ></mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @for (violation of violations(); track violation.company) {
          <h3># {{ violation.company }}</h3>

          @for (item of violation.violations.items; track item.id) {
          <div class="driver">
            <a
              mat-icon-button
              (click)="copyDriverName(item.driverName)"
              matTooltip="Copy to clipboard"
            >
              <mat-icon>content_copy</mat-icon>
            </a>
            <span>{{ item.driverName }}</span>
          </div>

          <ul>
            @for (v of item.violations; track v.violationId){
            <li>
              <span>{{ v.type }}</span>
            </li>
            }
          </ul>
          }
          <mat-divider></mat-divider>
          }
        </div>
      </mat-expansion-panel>
    </mat-accordion>

    }

    <!--  -->
    <!-- expansion panel -->
    <mat-accordion MatAccordionDisplayMode="flat">
      <!--  -->
      <!-- Teleports -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title> Teleports </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.teleports)) {
          <div class="scan-results__content__result__empty">No teleports.</div>
          } @else {
          <ul class="list-of-tenants">
            @for (company of scanResults.teleports | keyvalue; track
            company.key) {
            <li class="company">
              <span class="company-name">{{ company.key }}</span>
              @for (driver of company.value; track driver.driverName) {
              <div class="driver">
                <div class="btns">
                  <a
                    mat-icon-button
                    matTooltip="Open driver daily logs in web app"
                    (click)="
                      openLogs(
                        driver.events[0].driver.id,
                        driver.events[0].date,
                        driver.events[0].tenant
                      )
                    "
                  >
                    <mat-icon>open_in_browser</mat-icon>
                  </a>
                  <a
                    mat-icon-button
                    (click)="copyDriverName(driver.driverName)"
                    matTooltip="Copy to clipboard"
                  >
                    <mat-icon>content_copy</mat-icon>
                  </a>
                </div>

                <span class="bold">{{ driver.driverName }}</span>
              </div>
              <ul class="inner-ul">
                @for (event of driver.events; track event.id) {
                <li class="event-error">
                  <span class="view-id">#{{ event.viewId }}</span>

                  <span [ngClass]="'status ' + event.dutyStatus">{{
                    event.statusName
                  }}</span>

                  <span class="error-msg">
                    {{
                      event.isTeleport > 0
                        ? "teleport [ " + event.isTeleport + " miles ]"
                        : "odometer decreased"
                    }}
                  </span>

                  <a mat-icon-button matTooltip="Done" class="on-hover"
                    ><mat-icon>close</mat-icon></a
                  >
                </li>

                }
              </ul>
              }
            </li>
            }
          </ul>
          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- event Errors -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>event Errors</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.eventErrors)) {
          <div class="scan-results__content__result__empty">
            No event errors.
          </div>
          } @else {
          <ul class="list-of-tenants">
            @for (company of scanResults.eventErrors | keyvalue; track
            company.key) {
            <li class="company">
              <span class="company-name">{{ company.key }}</span>
              @for (driver of company.value; track driver.name) {
              <div class="driver">
                <div class="btns">
                  <a
                    mat-icon-button
                    matTooltip="Open driver daily logs in web app"
                    (click)="
                      openLogs(
                        driver.events[0].driver.id,
                        driver.events[0].date,
                        driver.events[0].tenant
                      )
                    "
                  >
                    <mat-icon>open_in_browser</mat-icon>
                  </a>
                  <a
                    mat-icon-button
                    (click)="copyDriverName(driver.name)"
                    matTooltip="Copy to clipboard"
                  >
                    <mat-icon>content_copy</mat-icon>
                  </a>
                </div>

                <span class="bold">{{ driver.name }}</span>
              </div>
              <ul class="inner-ul">
                @for (event of driver.events; track event.id) {
                <li class="event-error">
                  <span class="view-id">#{{ event.viewId }}</span>

                  <span [ngClass]="'status ' + event.dutyStatus">{{
                    event.statusName
                  }}</span>

                  <span class="error-msg">
                    {{ event.errorMessage }}
                  </span>

                  <a mat-icon-button matTooltip="Done" class="on-hover"
                    ><mat-icon>close</mat-icon></a
                  >
                </li>

                }
              </ul>

              }
            </li>
            }
          </ul>
          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- prolonged OnDutuis -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>{{ prolongedOnDutiesTitle }}</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.prolengedOnDuties)) {
          <span>No prolonged On Duties detected.</span>

          } @else {
          <ul>
            @for (onDuty of scanResults.prolengedOnDuties | keyvalue; track
            onDuty.key) {
            <li>
              <h3>{{ onDuty.key }}</h3>
              @for (driver of onDuty.value; track driver.id) {
              <div class="driver">
                <a
                  mat-icon-button
                  (click)="copyDriverName(driver.driverName)"
                  matTooltip="Copy to clipboard"
                >
                  <mat-icon>content_copy</mat-icon>
                </a>
                <span class="bold">{{ driver.driverName }}</span>
              </div>
              <span>
                - prolonged On Duty detected, duration:
                {{ driver.duration * 1000 | date : "H:mm" : "UTC" }}
              </span>
              }
            </li>
            }
          </ul>

          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- Malfunction / DataDiagnostic -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>{{ malfTitle }}</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.malfOrDataDiagDetection)) {
          <span>No malfunctions or data diagnostics detected.</span>
          <mat-divider></mat-divider>
          } @else {

          <ul>
            @for (detection of scanResults.malfOrDataDiagDetection | keyvalue;
            track detection.key) {
            <li>
              <h3>{{ detection.key }}</h3>
              @for (driver of detection.value; track driver) {
              <div class="driver">
                <a
                  mat-icon-button
                  (click)="copyDriverName(driver)"
                  matTooltip="Copy to clipboard"
                >
                  <mat-icon>content_copy</mat-icon>
                </a>
                <span class="bold">{{ driver }}</span>
              </div>
              <span>- malfunction or data diagnostic detected</span>
              }
            </li>
            }
          </ul>
          <mat-divider></mat-divider>
          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- PC/YM  -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title> PC / YM </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.pcYm)) {
          <span>No PC/YM events detected.</span>
          <mat-divider></mat-divider>
          } @else {

          <ul>
            @for (detection of scanResults.pcYm | keyvalue; track detection.key)
            {
            <li>
              <h3>{{ detection.key }}</h3>
              @for (driver of detection.value; track driver) {
              <div class="driver">
                <a
                  mat-icon-button
                  (click)="copyDriverName(driver)"
                  matTooltip="Copy to clipboard"
                >
                  <mat-icon>content_copy</mat-icon>
                </a>
                <span class="bold">{{ driver }}</span>
              </div>
              <span>- PC/YM event detected</span>
              }
            </li>
            }
          </ul>
          <mat-divider></mat-divider>
          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- missing Engine On events -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title> missing Engine On </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.missingEngineOn)) {
          <span>No missing Engine On events detected.</span>
          <mat-divider></mat-divider>
          } @else {

          <ul>
            @for (detection of scanResults.missingEngineOn | keyvalue; track
            detection.key) {
            <li>
              <h3>{{ detection.key }}</h3>
              @for (driver of detection.value; track driver) {
              <div class="driver">
                <a
                  mat-icon-button
                  (click)="copyDriverName(driver)"
                  matTooltip="Copy to clipboard"
                >
                  <mat-icon>content_copy</mat-icon>
                </a>
                <span class="bold">{{ driver }}</span>
              </div>
              <span>- missing Engine On detected</span>
              }
            </li>
            }
          </ul>
          <mat-divider></mat-divider>
          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- high elapsed Engine Hours -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>{{ elapsedEHTitle }}</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.highEngineHours)) {
          <span>No high elapsed Engine Hours events.</span>
          <mat-divider></mat-divider>
          } @else {
          <ul>
            @for (highEngineHoursEvent of scanResults.highEngineHours |
            keyvalue; track highEngineHoursEvent.key) {
            <li>
              <h3>{{ highEngineHoursEvent.key }}</h3>
              @for (driver of highEngineHoursEvent.value; track driver.id) {
              <div class="driver">
                <a
                  mat-icon-button
                  (click)="copyDriverName(driver.driverName)"
                  matTooltip="Copy to clipboard"
                >
                  <mat-icon>content_copy</mat-icon>
                </a>
                <span class="bold">{{ driver.driverName }}</span>
              </div>
              <span>
                - high elapsed Engine Hours event detected, count:
                {{ driver.duration }}
              </span>
              }
            </li>
            }
          </ul>
          <mat-divider></mat-divider>
          }
        </div>
      </mat-expansion-panel>

      <!--  -->
      <!-- low total Engine Hours events -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>{{ lowTotalEHTitle }}</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="scan-results__content__result">
          @if (isEmpty(scanResults.lowTotalEngineHours)) {
          <span>No low total Engine Hours events.</span>
          <mat-divider></mat-divider>
          } @else {

          <ul>
            @for (detection of scanResults.lowTotalEngineHours | keyvalue; track
            detection.key) {
            <li>
              <h3>{{ detection.key }}</h3>
              @for (driver of detection.value; track driver) {
              <div class="driver">
                <a
                  mat-icon-button
                  (click)="copyDriverName(driver)"
                  matTooltip="Copy to clipboard"
                >
                  <mat-icon>content_copy</mat-icon>
                </a>
                <span class="bold">{{ driver }}</span>
              </div>
              <span
                >- event(s) with low total Engine Hours events detected</span
              >
              }
            </li>
            }
          </ul>
          <mat-divider></mat-divider>
          }
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>
